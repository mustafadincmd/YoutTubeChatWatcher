@{
    ViewData["Title"] = "YouTube Canlı Chat İzleyici";
}

<h2>YouTube Canlı Chat İzleyici</h2>

<form asp-action="StartListening" method="post">
    <div>
        <label for="videoUrl">Canlı Yayın URL</label><br />
        <input id="videoUrl" name="videoUrl" type="url" required placeholder="https://www.youtube.com/watch?v=..." style="width: 400px;" />
    </div>
    <div>
        <label for="keyword">Anahtar Kelime</label><br />
        <input id="keyword" name="keyword" type="text" required style="width: 200px;" />
    </div>
    <div>
        <label for="matchLimit">Kaç Mesajda Ara (Max Eşleşme)</label><br />
        <input id="matchLimit" name="matchLimit" type="number" min="1" value="5" required style="width: 100px;" />
    </div>
    <br />
    <button type="submit">Dinlemeye Başla</button>
</form>

<hr />

<table id="results" border="1" style="width:100%; margin-top:20px; border-collapse: collapse;">
    <thead style="background-color: #f0f0f0;">
    <tr>
        <th style="padding: 8px;">#</th>
        <th style="padding: 8px;">Kullanıcı</th>
        <th style="padding: 8px;">Mesaj</th>
        <th style="padding: 8px;">Zaman</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.on("ReceiveMessage", function (msg) {
            const tableBody = document.querySelector("#results tbody");
            if (tableBody) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${msg.order}</td>
                    <td>${msg.author}</td>
                    <td>${msg.message}</td>
                    <td>${msg.time}</td>
                `;
                tableBody.appendChild(row);
            }
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
}
